name: Auto-create Idea Issues from README

on:
  push:
    paths:
      - "README.md"
  workflow_dispatch:

jobs:
  create-issues:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Set up GitHub CLI
      run: |
        sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-key C99B11DEB97541F0
        echo "deb [arch=amd64] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
        sudo apt update
        sudo apt install gh -y
    
    - name: Authenticate GitHub CLI
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: gh auth login --with-token <<< "$GH_TOKEN"

    - name: Extract Ideas and Create Issues
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        awk '
        BEGIN { RS="### [^#]"; in_ideas=0 }
        /^## What You Can Do\?/ { in_ideas=1; next }
        /^## / { if(in_ideas==1) in_ideas=0; next }
        in_ideas==1 && NR>1 {
          split($0, lines, "\n")
          title = lines[1]
          body = ""
          for (i=2; i<=length(lines); i++) {
            if (lines[i] ~ /^### /) break
            body = body lines[i] "\n"
          }
          gsub(/"/, "\\\"", body)
          print "TITLE>>>" title
          print "BODY>>>" body
        }
        ' README.md > ideas.txt

        # Loop through each extracted idea and create issue
        csplit -z -f idea_ ideas.txt '/^TITLE>>>/' '{*}'
        
        # Create a file to store issue URLs for the README update
        > issue_urls.txt
        
        for f in idea_*; do
          title=$(grep '^TITLE>>>' "$f" | sed 's/^TITLE>>> //')
          body=$(sed -n '/^BODY>>>/,$p' "$f" | sed 's/^BODY>>> //')

          # Check if issue exists or create new one
          issue_url=""
          if ! issue_data=$(gh issue list --state all --limit 100 --json title,url | jq -r ".[] | select(.title == \"$title\") | .url"); then
            echo "Creating issue: $title"
            issue_data=$(gh issue create \
              --title "$title" \
              --body "### Idea 💡\n\n$body\n\nVote by adding 👍 to this issue!" \
              --label "idea" \
              --json url | jq -r ".url")
            echo "Created issue: $issue_data"
          else
            echo "Issue already exists: $title"
          fi
          
          # Store the issue URL with its title for README update
          echo "$title|$issue_data" >> issue_urls.txt
        done
        
        # Update README.md with issue links for voting
        cp README.md README.md.bak
        awk -F'|' 'NR==FNR {issues[$1]=$2; next} 
        { 
          if ($0 ~ /^### [^#]/) { 
            title = substr($0, 4)
            gsub(/^[ \t]+/, "", title)
            if (issues[title] != "") {
              print $0 " [Vote 👍](" issues[title] ")"
            } else {
              print $0
            }
          } else {
            print $0
          }
        }' issue_urls.txt README.md.bak > README.md
        
    - name: Commit README changes
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add README.md
        git diff --staged --quiet || git commit -m "Add voting links to ideas in README"
        git push
